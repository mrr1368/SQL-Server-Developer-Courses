# 📚 جلسه شانزدهم - توابع پارامتری، APPLY، و Stored Procedures با مدیریت خطا در SQL Server

در این جلسه با تکنیک‌های پیشرفته در کار با توابع پارامتری، دستورات APPLY، و ساخت Stored Procedureهایی با مدیریت خطا آشنا می‌شویم. این مهارت‌ها برای بهینه‌سازی کوئری‌ها و کنترل بهتر عملیات در SQL Server بسیار ضروری هستند.

---

## 🗺️ خلاصه‌ی سریع موضوعات این جلسه

| دستور یا مفهوم | توضیح |
|:---|:---|
| `Scalar-Valued Functions (SVF)` | ساخت توابع خروجی تک‌مقداری برای محاسبه‌های خاص |
| `Table-Valued Functions (TVF)` | ساخت توابع بازگشتی چندردیفی با یا بدون پارامتر |
| `CROSS APPLY` و `OUTER APPLY` | اتصال توابع به جداول برای کوئری‌های پویا |
| `STRING_SPLIT` و `PIVOT` | تجزیه رشته‌ها و ساختاردهی داده‌ها به صورت جدولی |
| `Stored Procedures with TRY...CATCH` | ایجاد SP با مدیریت حرفه‌ای خطا |

---

## 🛠️ چیزهایی که در این جلسه یاد می‌گیریم

### 🎯 کار با توابع اسکالر و جدولی (SVF & TVF)

- ساخت تابع اسکالر `svfPublishersAmount` برای محاسبه مجموع فروش بر اساس شناسه ناشر

- تعریف تابع جدولی `tvfPublishersAmount` برای بازگرداندن چندین ردیف اطلاعات فروش

- مقایسه مزایا و کارایی توابع TVF نسبت به ویوها (View)

---

### 🎯 استفاده از APPLY در کوئری‌ها

- استفاده از `CROSS APPLY` و `OUTER APPLY` برای ارتباط رکوردها با توابع پارامتری

- نمایش اطلاعات ناشران و نویسندگان به صورت پویا بر اساس شرایط متغیر

---

### 🎯 پردازش رشته‌ها و ساختاردهی داده‌ها

- تجزیه داده‌های متنی با استفاده از `STRING_SPLIT`

- ایجاد جداول چرخشی (Pivot Table) از روی رشته‌های جدا شده با `PIVOT`

---

### 🎯 ایجاد Stored Procedure و مدیریت خطا

- طراحی Stored Procedureهایی مانند `spJobsInsert` و `spTitlesUpdate`

- دریافت و نمایش خطاها با TRY...CATCH و توابع سیستمی مثل `ERROR_MESSAGE()`, `ERROR_NUMBER()`, `ERROR_SEVERITY()`

- نمونه‌سازی خروجی و مشاهده مقادیر تغییر یافته با `OUTPUT`

---

## 📜 درباره این جلسه

در این جلسه تمرین می‌کنیم:
- چطور توابع حرفه‌ای بسازیم و در کوئری‌ها استفاده کنیم.
- چطور APPLY را برای اتصال توابع به داده‌های اصلی به کار ببریم.
- چطور داده‌های متنی را به فرمت جدولی تبدیل کنیم.
- چطور Stored Procedureهای مقاوم به خطا بنویسیم.

تمام تمرین‌ها روی دیتابیس **T_pubs** انجام شده‌اند.

---

## 📂 فایل موجود

- `Session 16.sql`: شامل نمونه‌های کامل از توابع پارامتری، APPLY، تحلیل رشته‌ای، و Stored Procedures با مدیریت خطا.

---

## ⚡ نکات مهم

- TVFها برای کوئری‌های پیچیده معمولاً نسبت به ویوها انعطاف‌پذیرتر و قابل نگهداری‌تر هستند.
- استفاده از `CROSS APPLY` باعث بهبود سرعت و دقت کوئری‌های شرطی می‌شود.
- پیاده‌سازی درست TRY...CATCH در SPها امکان مدیریت حرفه‌ای خطاها را فراهم می‌کند.

---

> ✨ این جلسه گامی بزرگ برای ساخت سیستم‌های حرفه‌ای‌تر، قابل نگهداری‌تر و مقاوم‌تر در برابر خطا در SQL Server است.

