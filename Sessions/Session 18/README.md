# 📚 جلسه هجدهم - Triggers، System-Versioned Tables، Transactions، Isolation Levels و Cursors در SQL Server

در این جلسه با تکنیک‌های پیشرفته‌ای برای مدیریت تغییرات، کنترل تراکنش‌ها، نگهداری تاریخچه داده‌ها و پردازش رکورد به رکورد آشنا می‌شویم. این ابزارها به ما کمک می‌کنند تا سیستم‌های حرفه‌ای‌تر، مقاوم‌تر و قابل پیگیری‌تر بسازیم.

---

## 🗺️ خلاصه‌ی سریع چیزهایی که در این جلسه یاد می‌گیریم

| Topic | Description |
|:---|:---|
| System-Versioned Temporal Tables | ساخت جداولی که تغییرات تاریخچه‌ای را خودکار ثبت می‌کنند |
| AFTER و INSTEAD OF Triggers | ثبت تغییرات و کنترل حذف نرم (Soft Delete) |
| Transaction Handling | مدیریت تراکنش‌ها با BEGIN, COMMIT, ROLLBACK و کنترل خطا با TRY...CATCH |
| Transaction Isolation Levels | انتخاب سطح مناسب برای کنترل قفل‌گذاری و همزمانی داده‌ها |
| Cursors | پردازش رکورد به رکورد برای کارهای خاص مثل Backup داینامیک |
| Stored Procedures | ساخت SPهای کاربردی برای عملیات درج، به‌روزرسانی و بکاپ‌گیری |

---

## 🛠️ چیزهایی که در این جلسه یاد می‌گیریم

### 🎯 کار با System-Versioned Temporal Tables

- معرفی جدول‌های زمان‌بندی شده برای نگهداری تاریخچه تغییرات.

- بازیابی داده‌های قبلی و مدیریت حالت versioning.

---

### 🎯 پیاده‌سازی انواع Triggers

- ساخت تریگرهای AFTER برای ثبت تغییرات پس از عملیات.

- ساخت تریگرهای INSTEAD OF برای کنترل دقیق عملیات قبل از اجرا.

- مدیریت Soft-Delete و Cascade Triggers.

---

### 🎯 مدیریت تراکنش‌ها و کنترل خطا

- شروع، تایید و بازگشت تراکنش‌ها با BEGIN، COMMIT و ROLLBACK.

- استفاده از TRY...CATCH برای جلوگیری از خراب شدن تراکنش‌ها.

- بررسی خطا با @@ERROR و استفاده از GOTO در سناریوهای خاص.

---

### 🎯 انتخاب سطح Isolation مناسب

- بررسی و مقایسه سطوح مختلف ایزولیشن (READ UNCOMMITTED، REPEATABLE READ، SNAPSHOT و ...).

- تاثیر انتخاب درست روی سرعت و صحت داده‌ها.

---

### 🎯 استفاده از Cursors در پردازش‌های خاص

- ساخت Cursorهای ساده برای پردازش رکورد به رکورد.

- مثال‌های واقعی برای Backup داینامیک دیتابیس‌ها.

---

### 🎯 ساخت Stored Procedures حرفه‌ای

- ایجاد Stored Procedureهای درج و به‌روزرسانی با کنترل خطا.

- اجرای Backup از چند دیتابیس به صورت داینامیک.

---

## 📜 درباره این جلسه

در این جلسه تمرین می‌کنیم:
- چطور داده‌های تغییر یافته را با تاریخچه کامل نگهداری کنیم.
- چطور تغییرات را با تریگرها به درستی مدیریت کنیم.
- چطور تراکنش‌های ایمن و کنترل شده طراحی کنیم.
- چطور عملیات‌های رکورد به رکورد را با Cursors انجام دهیم.
- چطور Stored Procedureهای حرفه‌ای بنویسیم.

تمام تمرین‌ها روی دیتابیس **T_pubs** انجام شده‌اند.

---

## 📂 فایل موجود

- `Session 18.sql`: شامل نمونه‌های کامل از System-Versioned Tables، Triggers، تراکنش‌ها، Isolation Levels، Cursors و Stored Procedures.

---

## ⚡ نکات مهم

- تریگرها باید با دقت نوشته شوند تا از مشکلات کارایی و حلقه‌های بی‌نهایت جلوگیری شود.
- System-Versioned Tables برای بررسی تغییرات تاریخی عالی هستند.
- انتخاب درست سطح ایزولیشن نقش مهمی در سرعت و درستی کوئری‌ها دارد.
- Cursors باید فقط در مواقع ضروری استفاده شوند و در حالت عادی بهتر است از عملیات‌های دسته‌ای (Set-based) استفاده شود.

---

> ✨ این جلسه پایه‌ای قوی برای ساخت سیستم‌های حرفه‌ای و مقاوم در برابر خطا در SQL Server ایجاد می‌کند.

